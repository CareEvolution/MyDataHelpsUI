import { FontAwesomeSvgIcon } from "react-fontawesome-svg-icon";
import { DailyDataType, DailyDataTypeDefinition } from "../daily-data-types";
import {
    faBed,
    faHeartbeat,
    faHourglassHalf,
    faPersonRunning
} from "@fortawesome/free-solid-svg-icons";
import React from "react";
import {
    defaultFormatter,
    heartRateFormatter,
    minutesFormatter,
    sleepYAxisConverter
} from "./formatters";
import combinedRestingHeartRate from "../daily-data-providers/combined-resting-heart-rate";
<<<<<<< HEAD
import {
    combinedMindfulMinutesDataProvider,
    combinedSleepDataProvider,
    combinedStepsDataProvider,
    combinedTherapyMinutesDataProvider
} from "../daily-data-providers";
import { combinedAvailabilityCheck, sources } from "./availability-check";
=======
import { combinedMindfulMinutesDataProvider, combinedSleepDataProvider, combinedStepsDataProvider, combinedTherapyMinutesDataProvider } from "../daily-data-providers";
import { simpleAvailabilityCheck, simpleAvailabilityCheckV2 } from "./availability-check";
import MyDataHelps from "@careevolution/mydatahelps-js";
>>>>>>> main
import { formatNumberForLocale } from "../../helpers/locale";

const RESTING_HEART_RATE_SOURCES = sources(
    ["AppleHealth", "RestingHeartRate"],
    ["Fitbit", "RestingHeartRate"],
    ["Garmin", "Daily"],
    ["HealthConnect", "resting-heart-rate", true]
);

const STEPS_SOURCES = sources(
    ["AppleHealth", "HourlySteps"],
    ["Fitbit", "Steps"],
    ["Garmin", "Daily"]
);

const STEPS_WITH_GOOGLE_FIT_SOURCES = sources(
    ["AppleHealth", "HourlySteps"],
    ["GoogleFit", "Steps"],
    ["Fitbit", "Steps"],
    ["Garmin", "Daily"]
);

const SLEEP_MINUTES_SOURCES = sources(
    ["AppleHealth", "SleepAnalysisInterval"],
    [
        "Fitbit",
        [
            "SleepLevelRem",
            "SleepLevelLight",
            "SleepLevelDeep",
            "SleepLevelAsleep"
        ]
    ],
    ["Garmin", "Sleep"],
    ["HealthConnect", "sleep", true]
);

const MINDFUL_MINUTES_SOURCES = sources(
    ["AppleHealth", "MindfulSession"],
    ["GoogleFit", "ActivitySegment"]
);

const THERAPY_MINUTES_SOURCES = sources(
    ["AppleHealth", "MindfulSession"],
    ["GoogleFit", "SilverCloudSession"]
);

let combinedTypeDefinitions: DailyDataTypeDefinition[] = [
    {
        dataSource: "Unified",
        type: DailyDataType.RestingHeartRate,
        dataProvider: combinedRestingHeartRate,
<<<<<<< HEAD
        availabilityCheck: combinedAvailabilityCheck(
            RESTING_HEART_RATE_SOURCES
        ),
=======
        availabilityCheck: async (modifiedAfter?: Date): Promise<boolean> => {
            const settings = await MyDataHelps.getDataCollectionSettings();

            if (settings.queryableDeviceDataTypes.find(dt => dt.namespace == "AppleHealth" && dt.type == "RestingHeartRate")
                && await simpleAvailabilityCheck("AppleHealth", "RestingHeartRate")(modifiedAfter)) {
                return true;
            }

            if (settings.fitbitEnabled && await simpleAvailabilityCheck("Fitbit", "RestingHeartRate")(modifiedAfter)) {
                return true;
            }

            if (settings.garminEnabled && await simpleAvailabilityCheck("Garmin", "Daily")(modifiedAfter)) {
                return true;
            }

            return settings.ouraEnabled && await simpleAvailabilityCheckV2("Oura", "heart-rate")(modifiedAfter);

        },
>>>>>>> main
        labelKey: "resting-heart-rate",
        icon: <FontAwesomeSvgIcon icon={faHeartbeat} />,
        formatter: heartRateFormatter,
        previewDataRange: [40, 100]
    },
    {
        dataSource: "Unified",
        type: DailyDataType.Steps,
        dataProvider: combinedStepsDataProvider,
<<<<<<< HEAD
        availabilityCheck: combinedAvailabilityCheck(STEPS_SOURCES),
=======
        availabilityCheck: async (modifiedAfter?: Date): Promise<boolean> => {
            const settings = await MyDataHelps.getDataCollectionSettings();

            if (settings.queryableDeviceDataTypes.find(dt => dt.namespace == "AppleHealth" && dt.type == "HourlySteps")
                && await simpleAvailabilityCheck("AppleHealth", "HourlySteps")(modifiedAfter)) {
                return true;
            }

            if (settings.fitbitEnabled && await simpleAvailabilityCheck("Fitbit", "Steps")(modifiedAfter)) {
                return true;
            }

            if (settings.garminEnabled && await simpleAvailabilityCheck("Garmin", "Daily")(modifiedAfter)) {
                return true;
            }

			return settings.ouraEnabled && await simpleAvailabilityCheckV2("Oura", "daily-activity")(modifiedAfter);
        },
>>>>>>> main
        labelKey: "steps",
        icon: <FontAwesomeSvgIcon icon={faPersonRunning} />,
        formatter: defaultFormatter,
        previewDataRange: [4000, 8000]
    },
    {
        dataSource: "Unified",
        type: DailyDataType.StepsWithGoogleFit,
        dataProvider: (startDate: Date, endDate: Date) =>
            combinedStepsDataProvider(startDate, endDate, true),
        availabilityCheck: combinedAvailabilityCheck(
            STEPS_WITH_GOOGLE_FIT_SOURCES
        ),
        labelKey: "steps",
        icon: <FontAwesomeSvgIcon icon={faPersonRunning} />,
        formatter: defaultFormatter,
        previewDataRange: [4000, 8000]
    },
    {
        dataSource: "Unified",
        type: DailyDataType.SleepMinutes,
        dataProvider: combinedSleepDataProvider,
<<<<<<< HEAD
        availabilityCheck: combinedAvailabilityCheck(SLEEP_MINUTES_SOURCES),
=======
        availabilityCheck: async (modifiedAfter?: Date): Promise<boolean> => {
            const settings = await MyDataHelps.getDataCollectionSettings();

            if (settings.queryableDeviceDataTypes.find(dt => dt.namespace == "AppleHealth" && dt.type == "SleepAnalysisInterval")
                && await simpleAvailabilityCheck("AppleHealth", "SleepAnalysisInterval")(modifiedAfter)) {
                return true;
            }

            if (settings.fitbitEnabled && await simpleAvailabilityCheck("Fitbit", ["SleepLevelRem", "SleepLevelLight", "SleepLevelDeep", "SleepLevelAsleep"])(modifiedAfter)) {
                return true;
            }

            if (settings.garminEnabled && await simpleAvailabilityCheck("Garmin", "Sleep")(modifiedAfter)) {
				return true;
			}

			return settings.ouraEnabled && await simpleAvailabilityCheckV2("Oura", "sleep")(modifiedAfter);
        },
>>>>>>> main
        labelKey: "sleep-time",
        icon: <FontAwesomeSvgIcon icon={faBed} />,
        formatter: minutesFormatter,
        yAxisConverter: sleepYAxisConverter,
        previewDataRange: [420, 540]
    },
    {
        dataSource: "Unified",
        type: DailyDataType.MindfulMinutes,
        dataProvider: combinedMindfulMinutesDataProvider,
        availabilityCheck: combinedAvailabilityCheck(MINDFUL_MINUTES_SOURCES),
        labelKey: "mindful-minutes",
        icon: <FontAwesomeSvgIcon icon={faHourglassHalf} />,
        formatter: value => formatNumberForLocale(value),
        previewDataRange: [0, 120]
    },
    {
        dataSource: "Unified",
        type: DailyDataType.TherapyMinutes,
        dataProvider: combinedTherapyMinutesDataProvider,
        availabilityCheck: combinedAvailabilityCheck(THERAPY_MINUTES_SOURCES),
        labelKey: "therapy-minutes",
        icon: <FontAwesomeSvgIcon icon={faHourglassHalf} />,
        formatter: value => formatNumberForLocale(value),
        previewDataRange: [0, 120]
    }
];
export default combinedTypeDefinitions;
